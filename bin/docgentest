#!/usr/bin/env bash

data_files=./bin/docgentest_data/*
result_dir=./_docgentest-results
mkdir -p $result_dir

echo "Here we go!"
echo "------"

for f in $data_files; do
  tmpfile=$(mktemp --tmpdir resolutionizer_response-XXXXXXXXX.json)
  file_base=`echo $f | sed -n -r 's/.+data\/(.*)\.json/\1/p'`

  echo "Processing: ${f}"

  echo "POSTing data to Resolutionizer API"
  curl -s -X POST -H "Content-Type: application/json" -d "@${f}" http://localhost:4000/api/v1/document > $tmpfile

  sleep 1 # takes a second to write that file

  original_url=`jq -r ".document.urls.original" $tmpfile`
  preview_url=`jq -r ".document.urls.preview" $tmpfile`

  echo "Downloading resulting files"
  curl -s $original_url > $result_dir/${file_base}_original.pdf
  curl -s $preview_url > $result_dir/${file_base}_preview.jpg

  rm $tmpfile
  echo "-----"
done

echo "Done! Results are in ${result_dir}!"
